@use 'sass:list';
@use 'sass:map';
@use 'config';
@use 'size';
@use 'mixins';

$default-prefix: 'u-';
$default-override: '';
$default-delimiter: '-';
$default-variant-delimiter: '\\:';

// ALL WIP
@mixin utility(
    $prefix: $default-prefix,
    $delimiter: $default-delimiter,
    $common-class-name,
    $class-value-pairs,
    $variants: (),
    $variant-delimiter: $default-variant-delimiter,
    $generate-viewports: false,
    $override: $default-override
) {
    @include utility-with-body(
            $prefix,
            $common-class-name,
            $class-value-pairs,
            $variants,
            $variant-delimiter,
            $generate-viewports,
            $override
        )
        using ($variant, $variant-delimiter, $prefix, $suffix, $common-class-name, $key, $value, $override) {
        // TODO Handle portrait and landscape

        $common-class: $common-class-name + $delimiter;
        @if $common-class-name == '' {
            $common-class: '';
        }

        @if $variant == 'dark' or $variant == 'light' {
            $variant-prefix: '';
            $variant-suffix: '';
            @if $variant != '' {
                $variant-prefix: $variant + $variant-delimiter;
            }

            $suffix-str: '';
            @if $suffix != '' {
                $suffix-str: $delimiter + $suffix;
            }

            @media (prefers-color-scheme: #{$variant}) {
                .#{$variant-prefix}#{$prefix}#{$common-class}#{$key}#{$suffix-str} {
                    @include mixins.explode-properties($value, $override);
                }
            }
        } @else if $variant == 'reduce-motion' {
            $variant-prefix: '';
            $variant-suffix: '';
            @if $variant != '' {
                $variant-prefix: $variant + $variant-delimiter;
            }

            $suffix-str: '';
            @if $suffix != '' {
                $suffix-str: $delimiter + $suffix;
            }

            @media (prefers-reduced-motion: reduce) {
                .#{$variant-prefix}#{$prefix}#{$common-class}#{$key}#{$suffix-str} {
                    @include mixins.explode-properties($value, $override);
                }
            }
        } @else {
            $variant-prefix: '';
            $variant-suffix: '';
            @if $variant != '' {
                $variant-prefix: $variant + $variant-delimiter;
                $variant-suffix: ':' + $variant;
            }

            $suffix-str: '';
            @if $suffix != '' {
                $suffix-str: $delimiter + $suffix;
            }

            .#{$variant-prefix}#{$prefix}#{$common-class}#{$key}#{$suffix-str}#{$variant-suffix} {
                @include mixins.explode-properties($value, $override);
            }
        }
    }
}

@mixin utility-with-body(
    $prefix: $default-prefix,
    $common-class-name,
    $class-value-pairs,
    $variants: (),
    $variant-delimiter: $default-variant-delimiter,
    $generate-viewports: false,
    $override: $default-override
) {
    // Iterate over variants, including no variants
    $variants: list.join('', $variants);
    @each $key, $value in $class-value-pairs {
        @each $variant in $variants {
            // No viewport
            @content ($variant, $variant-delimiter, $prefix, '', $common-class-name, $key, $value, $override);
        }
    }

    // Generate classes with viewport
    // Generation is separate and in this specific nesting order of for loops to allow gulp-clean-css to efficiently minify
    @if $generate-viewports == 'true' {
        @each $suffix, $limit in config.$breakpoint-pairs {
            @each $key, $value in $class-value-pairs {
                @include size.screen-above($limit) {
                    @each $variant in $variants {
                        @content ($variant, $variant-delimiter, $prefix, $suffix, $common-class-name, $key, $value, $override);
                    }
                }
            }
        }
    }
}

@function class-value-map-with-single-property($property, $property-values) {
    $result: ();

    @each $key, $value in $property-values {
        $result: map.set(
            $result,
            $key,
            (
                $property: $value,
            )
        );
    }

    @return $result;
}
